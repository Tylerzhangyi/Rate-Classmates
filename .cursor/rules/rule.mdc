---
alwaysApply: true
---

# Rate My Classmate 项目开发规则

## 架构与文档规范
- 每次出现架构更新需要同步更新description.md和er-diagram.puml
- 所有数据库表结构变更必须同步更新ER图和description.md中的实体说明
- API接口变更需要更新相关接口文档

## 数据库设计规范
- **数据库技术栈：必须使用SQLite数据库**
- SQLite中UUID类型使用TEXT类型存储，格式为36字符标准UUID字符串（如：`550e8400-e29b-41d4-a716-446655440000`）
- 所有主键使用TEXT类型存储UUID，命名格式：`{entity}_id`（如`student_id`）
- 外键命名格式：`{referenced_entity}_id`（如`school_id`）
- SQLite外键约束需要在连接时启用：`PRAGMA foreign_keys = ON;`
- 时间字段统一使用`created_at`、`updated_at`、`awarded_at`等语义化命名，SQLite中使用TEXT类型存储ISO8601格式（如：`2024-01-01T12:00:00Z`）或使用DATETIME类型
- 密码直接存储明文密码
- 评分字段`score`必须限制在1-5范围内，对应语义等级：夯=5, 顶级=4, 人上人=3, NPC=2, 拉完了=1
- Rating表必须设置唯一约束：`UNIQUE(rater_id, target_id)`，确保同一用户不能对同一目标重复评分
- RatingSummary表与Student表保持1:1关系，每个学生只有一条统计记录
- SQLite索引优化：为所有外键字段、常用查询字段（如school_id、grade、class_no、name）创建索引
- SQLite并发限制：注意SQLite的写并发限制，大量写入操作时考虑使用连接池和事务优化

## API设计规范
- RESTful API设计，使用标准HTTP方法（GET、POST、PUT、DELETE）
- 统一响应格式：`{code, message, data}`
- 错误码规范：200成功，400客户端错误，401未授权，403禁止访问，404未找到，500服务器错误
- 分页参数统一使用：`page`（页码）、`page_size`（每页数量）
- 排序参数格式：`sort_by={field}&order={asc|desc}`
- 所有需要认证的接口必须在请求头中包含认证token

## 业务逻辑规范
- 评分等级显示：默认显示出现次数最多的等级，同时显示平均分和总评分数
- 排行榜计算：基于RatingSummary表的avg_score和rating_count，支持按周期（周/月/季度）生成
- 徽章授予：根据预定义规则自动计算，支持学生徽章和学校徽章两种类型
- 搜索功能：支持多条件组合查询（学校、年级、班级、姓名、平均分区间）
- 评论排序：支持按时间（最新/最旧）和热度（点赞数/回复数）排序

## 代码规范
- 使用有意义的变量和函数命名，遵循项目约定的命名风格
- 函数保持单一职责，避免过长函数（建议不超过50行）
- 关键业务逻辑必须添加注释说明
- 错误处理：使用try-catch捕获异常，记录错误日志，返回友好的错误信息
- 避免硬编码，配置项（如评分等级映射、榜单周期）应存储在数据库中

## 测试规范
- 核心业务逻辑（评分、统计、排行榜计算）必须编写单元测试
- API接口必须编写集成测试，覆盖正常流程和异常情况
- 数据库操作必须测试事务回滚和并发场景
- 安全相关功能（认证、权限、输入验证）必须进行安全测试

## 性能优化规范
- 排行榜数据使用缓存机制，避免频繁计算
- RatingSummary表通过触发器或定时任务自动更新，避免实时计算
- 大量数据查询必须使用索引优化，特别是外键字段和常用查询字段
- 分页查询必须限制最大page_size，防止一次性加载过多数据
- 评论列表使用懒加载或分页，避免一次性加载所有评论
- SQLite性能优化：
  - 使用WAL模式（Write-Ahead Logging）提高并发读写性能：`PRAGMA journal_mode = WAL;`
  - 批量写入操作使用事务包裹，减少磁盘I/O
  - 使用预编译语句（prepared statements）提高查询性能

## 数据一致性规范
- Rating表新增/更新/删除时，必须同步更新对应的RatingSummary记录
- 学生删除时，需要处理级联删除或软删除相关评分和评论
- 排行榜生成时，必须基于RatingSummary的快照数据，确保榜单期间数据一致性
- 徽章授予逻辑必须考虑数据一致性，避免重复授予或遗漏
- SQLite事务处理：
  - 所有涉及多表操作的业务逻辑必须使用事务确保原子性
  - 使用BEGIN TRANSACTION、COMMIT、ROLLBACK确保数据一致性
  - 启用外键约束后，级联删除操作需要在事务中执行

## 用户体验规范
- 所有用户操作必须提供明确的反馈（成功提示、错误提示）
- 加载状态必须显示loading指示器
- 表单验证错误必须实时提示，避免用户提交后才发现错误
- 搜索和筛选结果为空时，显示友好的提示信息
- 移动端适配：确保界面在移动设备上正常显示和操作
